import './polyfills.server.mjs';
import{a as B,b as G}from"./chunk-4SAFYYLL.mjs";import{c as M,d as g,e as V,f as D,i as R,j as P,k as O,o as A,p as H,q as j,r as N,s as W}from"./chunk-HNBXNW4H.mjs";import{j as E,m as T,q as F}from"./chunk-DRDXN4ZN.mjs";import{Ba as u,Ca as d,Hb as w,Qa as v,Sa as p,X as h,Xa as n,Ya as s,Za as c,ab as x,bb as y,bc as I,cb as S,cc as k,da as b,ea as _,ib as l,rb as C}from"./chunk-TFB3ESHJ.mjs";import"./chunk-5XUXGTUW.mjs";function q(a,L){if(a&1){let t=x();n(0,"button",17),y("click",function(){b(t);let r=S();return _(r.publishStory())}),c(1,"i",18),l(2," Publish "),s()}}function U(a,L){a&1&&(n(0,"button",19),c(1,"i",20),l(2," Save Draft "),s())}var it=(()=>{class a{constructor(t,e,r,i,o){this.contentService=t,this.fb=e,this.router=r,this.route=i,this.cd=o,this.storyId=null,this.isReadOnly=!1,this.storyForm=this.fb.group({story_title:["",g.required],story_content:["",g.required]}),this.setEditorConfig(!1)}ngOnInit(){if(!sessionStorage.getItem("userId")){this.router.navigate(["login"]);return}this.route.paramMap.subscribe(e=>{let r=e.get("idAndTitle");if(r){let i=r.split("-")[0];this.storyId=parseInt(i,10),console.log("Story ID:",this.storyId),this.loadStory()}})}loadStory(){this.storyId&&this.contentService.getStoryById(this.storyId).subscribe({next:t=>{if(t.status==="success"&&t.data){let e=t.data.content||"",r=t.data.story_title||"";e=this.cleanWordHTML(e),this.storyForm.patchValue({story_title:r,story_content:e}),setTimeout(()=>{tinymce.activeEditor&&tinymce.activeEditor.setContent(e)},100),this.isReadOnly=t.data.status===1,this.setEditorConfig(this.isReadOnly),this.cd.detectChanges(),console.log("Story title loaded:",r)}},error:t=>console.error("Error loading story:",t)})}cleanWordHTML(t){return t?t.replace(/<!--[\s\S]*?-->/g,"").replace(/<(\w+)[^>]*>\s*<\/\1>/g,"").replace(/<(\w+)[^>]*class="[^"]*"[^>]*>/g,"<$1>").replace(/<(\w+)[^>]*style="[^"]*"[^>]*>/g,"<$1>").replace(/<span[^>]*>/g,"").replace(/<\/span>/g,"").replace(/<font[^>]*>/g,"").replace(/<\/font>/g,"").replace(/<o:p>|<\/o:p>/g,"").replace(/<(\w+)[^>]*>(&nbsp;|\s)*<\/\1>/g,"").replace(/&nbsp;/g," ").replace(/\s+/g," ").trim():""}setEditorConfig(t){this.editorConfig={height:500,menubar:!1,plugins:["lists","link","image","code","paste"],toolbar:"undo redo | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent | removeformat | code",readonly:t,directionality:"ltr",paste_as_text:!1,paste_block_drop:!0,paste_data_images:!1,paste_webkit_styles:"none",paste_remove_styles:!0,paste_remove_styles_if_webkit:!0,paste_strip_class_attributes:"all",valid_elements:"p,h1,h2,h3,h4,h5,h6,strong,em,b,i,u,a[href|target=_blank],ul,ol,li,img[src|alt|width|height],br,hr,blockquote,pre,code",invalid_elements:"script,iframe,object,embed,style,link,form,input,textarea,button,table,tr,td",content_css:!1,cleanup:!0,verify_html:!0}}updateContent(){setTimeout(()=>{if(tinymce.activeEditor){let t=tinymce.activeEditor.getContent()||"";this.storyForm.controls.story_content.setValue(t),this.storyForm.updateValueAndValidity(),this.cd.detectChanges()}},0)}publishStory(){this.updateContent(),setTimeout(()=>{let t=this.storyForm.getRawValue(),e=(t.story_title||"").trim(),r=(t.story_content||"").trim();if(!this.storyId){alert("\u26A0 Cannot publish. Story ID is missing.");return}if(!e||!r||e.length>255||this.stripHtml(r).trim().length<10){alert("\u26A0 Please complete the title and content before publishing.");return}let i=new FormData;i.append("story_id",String(this.storyId)),i.append("story_title",e),i.append("story_content",r),this.contentService.publishStory(i).subscribe({next:o=>{o.status==="success"?(alert("\u2705 Story published successfully!"),this.router.navigate(["/myworks"])):alert("\u26A0 Failed to publish: "+(o.message||"Unknown error"))},error:o=>{console.error("Publish error:",o),alert("\u26A0 Server error occurred during publish.")}})},10)}onSubmit(){this.updateContent(),setTimeout(()=>{let t=this.storyForm.getRawValue(),e=(t.story_title||"").trim(),r=(t.story_content||"").trim();if(!e){alert("\u26A0 Please enter a story title"),this.storyForm.controls.story_title.markAsTouched();return}if(e.length>255){alert("\u26A0 Title is too long (max 255 characters)");return}if(!r){alert("\u26A0 Please enter story content"),this.storyForm.controls.story_content.markAsTouched();return}if(this.stripHtml(r).trim().length<10){alert("\u26A0 Story content must contain at least 10 characters (excluding HTML)");return}let o=new FormData;o.append("story_id",String(this.storyId)),o.append("story_title",e),o.append("story_content",r),this.storyId&&o.append("story_id",String(this.storyId));let f=sessionStorage.getItem("userId");f&&o.append("user_id",f),console.log("Sending FormData:",{story_id:o.get("story_id"),story_title:o.get("story_title"),story_content:o.get("story_content")}),(this.storyId?this.contentService.updateStory(o):this.contentService.addStory(o)).subscribe({next:m=>{console.log("Server response:",m),m.status==="success"?alert("\u2713 Story saved successfully!"):alert(`\u26A0 Server error: ${m.message||"Unknown error"}`)},error:m=>{console.error("API error:",m),alert("\u26A0 Failed to save story. Please check console for details.")}})},10)}stripHtml(t){let e=document.createElement("div");return e.innerHTML=t,e.textContent||e.innerText||""}goBack(){window.history.back()}static{this.\u0275fac=function(e){return new(e||a)(d(N),d(A),d(T),d(E),d(w))}}static{this.\u0275cmp=h({type:a,selectors:[["app-writestory"]],standalone:!0,features:[C],decls:24,vars:4,consts:[[1,"container","mx-auto","px-4","lg:px-6","pb-20"],[3,"ngSubmit","formGroup"],[1,"bg-white","dark:bg-gray-800","rounded-lg","shadow-sm","mb-6"],[1,"p-6","border-b","border-gray-200","dark:border-gray-700"],["type","text","formControlName","story_title","placeholder","Untitled Part",1,"w-full","text-2xl","font-bold","bg-transparent","focus:outline-none","focus:ring-0","p-0"],["formControlName","story_content",3,"init"],[1,"bg-white","dark:bg-gray-800","rounded-lg","p-6","shadow-sm"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","space-x-4"],[1,"w-12","h-12","rounded-full","bg-gray-200","dark:bg-gray-700","flex","items-center","justify-center"],[1,"text-gray-500","dark:text-gray-400"],[1,"text-xl","lg:text-2xl","font-bold"],[1,"text-sm","text-wattpad-light"],["id","wordCount"],[1,"flex","flex-wrap","gap-3"],["class","pointer px-6 py-2 rounded-full font-medium bg-wattpad-primary text-white hover:bg-[#E5274B] transition-colors","type","button",3,"click",4,"ngIf"],["type","submit","class","px-6 py-2 rounded-full font-medium border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",4,"ngIf"],["type","button",1,"pointer","px-6","py-2","rounded-full","font-medium","bg-wattpad-primary","text-white","hover:bg-[#E5274B]","transition-colors",3,"click"],[1,"fas","fa-upload","mr-2"],["type","submit",1,"px-6","py-2","rounded-full","font-medium","border","border-gray-300","dark:border-gray-600","hover:bg-gray-100","dark:hover:bg-gray-700","transition-colors"],[1,"fas","fa-save","mr-2"]],template:function(e,r){e&1&&(c(0,"app-header"),n(1,"main",0)(2,"form",1),y("ngSubmit",function(){return r.onSubmit()}),n(3,"div",2)(4,"div",3),c(5,"input",4),s(),c(6,"editor",5),s(),n(7,"div",6)(8,"div",7)(9,"div",8)(10,"div",9)(11,"span",10),l(12,"R"),s()(),n(13,"div")(14,"h1",11),l(15,"Midnight Secrets"),s(),n(16,"p",12),l(17,"Part 1 \u2022 "),n(18,"span",13),l(19,"0"),s(),l(20," words"),s()()(),n(21,"div",14),v(22,q,3,0,"button",15)(23,U,3,0,"button",16),s()()()()()),e&2&&(u(2),p("formGroup",r.storyForm),u(4),p("init",r.editorConfig),u(16),p("ngIf",!r.isReadOnly),u(),p("ngIf",!r.isReadOnly))},dependencies:[k,I,H,R,M,V,D,j,P,O,G,B,W,F],styles:[".writemenu[_ngcontent-%COMP%]{margin-bottom:30px;text-align:right}.writemenu[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{margin:10px}"]})}}return a})();export{it as WritestoryComponent};
